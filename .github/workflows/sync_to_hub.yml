name: Sync to Hugging Face Hub

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Push to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install -q huggingface-hub
          python - <<'EOF'
          import os, shutil
          from huggingface_hub import HfApi, upload_folder
          from pathlib import Path

          token = os.environ["HF_TOKEN"]
          repo_id = "hssling/derm-analyzer-api"

          # Copy only Space-needed files into a temp folder
          tmp = Path("/tmp/hf_space")
          tmp.mkdir(exist_ok=True)
          for fname in ["app.py", "requirements.txt", "README.md"]:
              src = Path(fname)
              if src.exists():
                  shutil.copy(src, tmp / fname)

          upload_folder(
              repo_id=repo_id,
              repo_type="space",
              folder_path=str(tmp),
              token=token,
              commit_message=f"Sync from GitHub CI",
              ignore_patterns=["*.pyc", "__pycache__"],
          )
          print(f"Successfully uploaded to {repo_id}")
          EOF
